%\section{Supporting Scripts and Tools}

\section{Example Makefile for FPGA Build and Programming}
\begin{adjustbox}{max width=\textwidth}
\begin{lstlisting}[language=make, caption={Sample Makefile targets for building and programming FPGA.}, numbers=left, numberstyle=\tiny, stepnumber=1, firstnumber=1]
# Target: Build the FPGA bitstream
bitstream:
	vivado -mode batch -source build_fpga.tcl

# Target: Program the FPGA
program:
	vivado -mode batch -source program_fpga.tcl

# Target: Clean generated files
clean:
	rm -rf *.log *.jou *.bit *.bin build/
\end{lstlisting}
\end{adjustbox}

\section{Python Fault-Injection Script}

\begin{lstlisting}[language=Python, caption={Python outline for automated fault injection with FPGA.}]
# -*- coding: utf-8 -*-
"""
Needs the following dependencies:
    pip3 install pyserial
    pip3 install tqdm

Injects Frame Error in sem IP core using UART.
The frames for injection where previously generated 
with ACME (http://www.nebrija.es/aries/acme.htm)
"""
import serial
import time
from datetime import datetime
import os
from tqdm import tqdm

def timing(t):
    t_new = time.mktime(time.localtime())
    return t_new - t

# SEM IP Core Connection    
port = '/dev/ttyUSB0'
baudrate = 115200

print('Conecting to SEM IP Core... \n',end='')
sem = serial.Serial(port, baudrate, timeout=3)
print('Connected')

# DUT Checker Connection    
port = '/dev/ttyUSB3'
baudrate = 115200

print('Conecting to DUT Checker... \n',end='')
dut = serial.Serial(port, baudrate, timeout=3)
print('Connected')

#frameRange = open('frameRange.txt')

testReport = open("testReport.txt",mode="w+",encoding="utf-8")

idle = 'I'
observation = 'O'
reset = 'R 00'
result_dut = 'A'
print('Partial ReConfigure as a Multiplier... \n')
operation = '1' # Mult = 1 | Add = 2
#dut.write(operation.encode())
#time.sleep(1)
#print('Reset SEM IP after Partial Reconfiguration... \n')
#sem.write(reset.encode())

print('Error Injection will start... \n')

with tqdm(total=os.path.getsize('frameRange.txt')) as pbar:
    with open('frameRange.txt') as frameRange:
        for line in frameRange:
            pbar.update(len(line.encode('utf-8')))
            sem.write(idle.encode())
            #print(idle.encode())
            time.sleep(0.1)
            injection = 'N' + ' ' + str(line)
            #print(injection.encode())
            sem.write(injection.encode())
            time.sleep(0.1)
            #print(result_dut.encode())
            dut.write(result_dut.encode())
            chk = dut.read()
            chks = chk.decode('utf-8')
            result = 'Frame: ' + str(line.rstrip()) + ' | ' + 'DUT Checker: ' + str(chks) + '\n'
            testReport.write(result)
            #print(observation.encode()) 
            sem.write(observation.encode())

print('Error Injection ended... \n')

sem.close()
dut.close()
frameRange.close()
testReport.close()
\end{lstlisting}

\section{Example Partial Bitstream Load Script (Python)}

\begin{lstlisting}[language=Python, caption={Python script to trigger partial dynamic reconfiguration on FPGA.}]
import subprocess

def load_partial_bitstream(bitstream_path):
    # Example using Vivado hardware manager Tcl batch
    tcl_cmd = f"open_hw; connect_hw_server; open_hw_target; current_hw_device [lindex [get_hw_devices] 0]; "
    tcl_cmd += f"program_hw_devices {bitstream_path}; exit"
    subprocess.run(["vivado", "-mode", "batch", "-source", tcl_cmd])

# Load faulty module repair
load_partial_bitstream("reconfig_partition.bit")
\end{lstlisting}
